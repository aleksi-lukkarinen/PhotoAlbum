{% extends "base-template.html" %}
{% load albumizer_common %}
{% load url from future %}

{% block page_title %}{{ albumTitle }}{% endblock %}
      {% block page_scripts_after %}
        $(function() {
            $(document).on("click", ".previousLink a, .nextLink a", function(evt) {
                evt.preventDefault();
                var myUrl=$(this).attr("href");
                
                //first make sure the current page has a state object
                var picturedata=$("#ajaxContainer").html();
                var cssdata=$("#cssContainer").html();
                var state={"picturedata":picturedata,
                           "cssdata": cssdata};
                window.history.replaceState(state, document.title, document.location);
                
                $.getJSON(myUrl+"?ajax=1", function(data) {
                        
                        $("#ajaxContainer").html(data.ajaxContainer);
                        $("#cssContainer").html(data.cssContainer);
                        
	                    var picturedata=data.ajaxContainer;
	                    var cssdata=data.cssContainer;
	                    var state={"picturedata":picturedata,
	                               "cssdata": cssdata};
	                    window.history.pushState(state, document.title, myUrl);
	      
	                    
	                    $(".actionButtonContainer form").attr("action", myUrl);
                 });
            });
            window.onpopstate=function(event) {
              //alert(document.location+": popping "+JSON.stringify(event.state));
              if(event.state && event.state.picturedata) {
                $("#ajaxContainer").html(event.state.picturedata);
                $("#cssContainer").html(event.state.cssdata);
                $(".actionButtonContainer form").attr("action", document.location);
              }
            };
        });
        $(function() {
            $(".actionButtonContainer input").button();
        });
      {% endblock %}
{% block header_definitions_before %}
	<style id="cssContainer" type="text/css">
	{{ cssContent }}
	</style>
{% endblock %}

{% block page_content %}

  <article class="albumBrowser hlisting">
    {% show_messages %}

    <div>
		<h1 class="fn">{{ albumTitle }}</h1>

	    {% if request.user.is_authenticated %}
	    <div class="actionButtonContainer">
	      <form name="frmAlbumAction" method="post" action="{% url "show_single_page" album_id pageNumber %}">
	        {% csrf_token %}
            {% if current_user_can_edit %}
            <input type="submit" name="addPage" value="Add Page">
            <input type="submit" name="editPage" value="Edit Page">
            {% endif %}
	        {% if current_user_can_delete %}
	        {# <input type="submit" name="deletePage" name="id_cmdDeletePage" value="Delete Page"> #}
	        {% endif %}
	      </form>
	    </div>
	    {% endif %}
    </div>
    
    <div class="clear"></div>

	<div id="ajaxContainer">
		<h2>You are viewing page {{ pageNumber}} from album "{{ albumTitle }}"</h2>
        {% show_messages %}
        <div class="albumpagewrapper">
			<div class="albumpagecontainer {{layoutCssClass}}">
				{% for text in texts %}
				<span id="text{{ forloop.counter}}">{{ text }}</span>
				{% endfor %}
				{% for image in images %}
				<img id="image{{ forloop.counter}}" src="{{ image.url }}" alt="Page {{ pageNumber }}" />
				{% endfor %}
			</div>
			<div>
			{% if previousLink %}
				<div class="previousLink"><a href="{{ previousLink }}">&lt;&lt; Previous page</a></div>
			{% endif %}
			{% if nextLink %}
				<div class="nextLink"><a href="{{ nextLink }}">Next page &gt;&gt;</a></div>
			{% endif %}
				<div class="clear"></div>
			</div>
		</div>
	   {% include "album/view-album-page-single-ajaxContainer.html" %}
	</div>

  </article>
{% endblock %}
